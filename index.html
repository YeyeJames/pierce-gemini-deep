<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pierce çš„æ‹¼å­—å¤§å†’éšª v3.1 (ä¿®æ­£ç‰ˆ)</title>
    <style>
        /* --- åŸºç¤ CSS --- */
        :root {
            --primary-color: #4CAF50;
            --bg-color: #f4f4f9;
            --text-color: #333;
            --card-bg: white;
            --accent-color: #ff9800;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-color); transition: background-color 0.5s, color 0.5s; }
        
        /* --- ä¸»é¡Œæ¨£å¼ (Themes) --- */
        body.theme-ocean { --primary-color: #0288D1; --bg-color: #E1F5FE; --text-color: #01579B; --card-bg: #fff; }
        body.theme-dark { --primary-color: #BB86FC; --bg-color: #121212; --text-color: #E0E0E0; --card-bg: #1E1E1E; --accent-color: #03DAC6; }
        body.theme-lego { --primary-color: #D32F2F; --bg-color: #FFEB3B; --text-color: #212121; --card-bg: #FFF9C4; --accent-color: #1976D2; }
        body.theme-forest { --primary-color: #2E7D32; --bg-color: #E8F5E9; --text-color: #1B5E20; --card-bg: #fff; }
        body.theme-space { --primary-color: #3F51B5; --bg-color: #000022; --text-color: #E8EAF6; --card-bg: #1A237E; --accent-color: #FF4081; }

        /* --- ä½ˆå±€ --- */
        #header { position: fixed; top: 0; left: 0; width: 100%; background-color: var(--primary-color); color: white; padding: 10px 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000; display: flex; justify-content: space-between; align-items: center; box-sizing: border-box;}
        #stats { display: flex; gap: 20px; font-size: 1.1em; align-items: center; }
        #pet-display { font-size: 1.8em; margin-right: 5px; animation: bounce 2s infinite; display: none; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        #content { padding-top: 80px; padding-bottom: 40px; max-width: 800px; margin: auto; padding-left: 10px; padding-right: 10px; }
        .section { background-color: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.08); margin-bottom: 20px; transition: background-color 0.5s; }
        h2, h3, h4 { color: var(--primary-color); border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 0; }
        
        /* --- æ§åˆ¶é … --- */
        select, input { padding: 12px; font-size: 18px; border-radius: 8px; border: 2px solid #ccc; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
        input:focus { border-color: var(--primary-color); outline: none; }
        
        button { padding: 10px 18px; font-size: 16px; border: none; border-radius: 8px; cursor: pointer; transition: transform 0.1s, opacity 0.2s; margin: 5px; font-weight: bold; }
        button:active { transform: scale(0.95); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-secondary { background-color: var(--accent-color); color: white; }
        .btn-danger { background-color: #f44336; color: white; }
        .btn-shop { background: linear-gradient(45deg, #FFD700, #FFA500); color: #333; box-shadow: 0 4px 0 #b8860b; }
        .btn-shop:active { box-shadow: 0 0 0; transform: translateY(4px); }

        /* --- ç·´ç¿’å€ --- */
        #quiz-area { text-align: center; }
        #word-display { font-size: 2.5em; margin: 20px 0; min-height: 50px; font-weight: bold; letter-spacing: 1px; color: var(--text-color); }
        #chinese-display { font-size: 1.4em; color: #777; margin-bottom: 20px; min-height: 30px; }
        .message { margin-top: 15px; font-weight: bold; font-size: 1.1em; padding: 10px; border-radius: 5px; }
        .msg-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .msg-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        /* --- éŒ„éŸ³å€ --- */
        #recording-section { border-top: 2px dashed #ccc; margin-top: 20px; padding-top: 10px; }

        /* --- å•†åº—èˆ‡èƒŒåŒ… --- */
        .shop-tabs { display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto; }
        .tab-btn { flex: 1; background-color: #ddd; color: #666; white-space: nowrap; min-width: 80px; }
        .tab-btn.active { background-color: var(--primary-color); color: white; }

        .shop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .shop-card { border: 2px solid #eee; border-radius: 10px; padding: 10px; text-align: center; background: var(--card-bg); display: flex; flex-direction: column; justify-content: space-between; height: 100%; box-sizing: border-box; }
        .shop-card.owned { border-color: #4CAF50; opacity: 0.8; }
        .shop-icon { font-size: 3em; margin-bottom: 5px; display: block; }
        .shop-price { color: #d32f2f; font-weight: bold; display: block; margin: 5px 0; }
        .shop-desc { font-size: 0.85em; color: #666; margin-bottom: 8px; flex-grow: 1; }

        /* --- æŠ½å¡å‹•ç•«å€ --- */
        #gacha-animation { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; text-align: center; color: white; padding-top: 15%; }
        .gacha-box { font-size: 8em; animation: shake 0.5s infinite; cursor: pointer; user-select: none; }
        @keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(5deg); } 50% { transform: rotate(0deg); } 75% { transform: rotate(-5deg); } 100% { transform: rotate(0deg); } }
        .gacha-result { font-size: 8em; display: none; animation: pop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        
        .rarity-common { color: #fff; text-shadow: 0 0 10px #aaa; }
        .rarity-rare { color: #42b72a; text-shadow: 0 0 15px #42b72a; }
        .rarity-legend { color: #ff00de; text-shadow: 0 0 20px #ff00de; }
        .rarity-epic { color: gold; text-shadow: 0 0 25px gold; }
        .rarity-mythic { color: #00ffff; text-shadow: 0 0 30px #00ffff; animation: rainbow 2s infinite; }
        @keyframes rainbow { 0%{filter: hue-rotate(0deg);} 100%{filter: hue-rotate(360deg);} }

        /* --- è²¼ç´™ç°¿ (Collection) --- */
        #sticker-book { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 8px; margin-top: 10px; max-height: 400px; overflow-y: auto; }
        .sticker-slot { aspect-ratio: 1; background-color: #eee; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 2em; border: 2px dashed #ccc; opacity: 0.3; filter: grayscale(100%); transition: all 0.3s; position: relative; }
        .sticker-slot.unlocked { opacity: 1; filter: grayscale(0%); background-color: #fff; border: 2px solid transparent; }
        .sticker-slot.unlocked.r-ç¨€æœ‰ { border-color: #42b72a; box-shadow: 0 0 5px #42b72a; }
        .sticker-slot.unlocked.r-å‚³èªª { border-color: #ff00de; box-shadow: 0 0 8px #ff00de; }
        .sticker-slot.unlocked.r-å²è©© { border-color: gold; box-shadow: 0 0 12px gold; }
        .sticker-slot.unlocked.r-ç¥è©± { border-color: #00ffff; box-shadow: 0 0 15px #00ffff; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; }
        .modal-content { background: var(--card-bg); margin: 5% auto; padding: 20px; width: 90%; max-width: 600px; border-radius: 12px; position: relative; max-height: 90vh; overflow-y: auto; }
        .close-btn { position: absolute; right: 15px; top: 10px; font-size: 24px; cursor: pointer; }

    </style>
</head>
<body class="">

    <div id="header">
        <div id="stats">
            <span id="pet-display"></span>
            <span>ğŸ’° <span id="coin-count">0</span></span>
            <span>ğŸ”¥ é€£å°: <span id="streak-count">0</span></span>
        </div>
        <div>
            <button class="btn-shop" onclick="toggleShop()">ğŸª å†’éšªå•†åŸ</button>
            <button class="btn-secondary" onclick="toggleRules()">ğŸ“œ</button>
        </div>
    </div>

    <div id="content">
        <div class="section">
            <h3>ğŸ“… é¸æ“‡æŒ‘æˆ°é€±æ¬¡</h3>
            <select id="week-select" onchange="loadWeek()">
                <option value="">-- è«‹é¸æ“‡ --</option>
            </select>
        </div>

        <div id="quiz-area" class="section">
            <h2 id="status-text">æº–å‚™é–‹å§‹</h2>
            
            <div id="word-display">è«‹é¸æ“‡é€±æ¬¡</div>
            <div id="chinese-display"></div>

            <div style="margin-bottom: 20px;">
                <input type="text" id="answer-input" placeholder="è¼¸å…¥æ‹¼å­—..." disabled autocomplete="off">
            </div>

            <div id="controls">
                <button id="submit-btn" class="btn-primary" onclick="checkAnswer()" disabled>é€å‡ºç­”æ¡ˆ</button>
                <button id="next-btn" class="btn-primary" onclick="nextQuestion()" disabled>ä¸‹ä¸€é¡Œ â¡</button>
            </div>
            
            <div style="margin-top: 10px;">
                <button id="speak-btn" class="btn-secondary" onclick="speakCurrentWord()" disabled>ğŸ”Š è½ç™¼éŸ³</button>
                <button id="hint-btn" class="btn-secondary" onclick="useHint()" style="display:none; background-color: #9C27B0;">ğŸ’¡ æç¤º (-5å¹£)</button>
            </div>

            <div id="message-box"></div>

            <div id="recording-section">
                <h4>ğŸ™ï¸ æˆ‘çš„å°ˆå±¬ç­†è¨˜</h4>
                <div id="user-hint-display" style="color: #666; font-style: italic; margin-bottom: 10px;"></div>
                <button class="btn-secondary" onclick="recordHint()" id="record-btn" disabled>âœï¸ å¯«ä¸‹æç¤º/ç­†è¨˜</button>
            </div>
        </div>
    </div>

    <div id="shop-modal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close-btn" onclick="toggleShop()">&times;</span>
            <h2 style="text-align: center;">ğŸª Pierce çš„å†’éšªå•†åŸ</h2>
            <div style="text-align: center; margin-bottom: 10px;">æŒæœ‰é‡‘å¹£: <b id="shop-coins" style="color: gold; font-size: 1.2em;"></b></div>

            <div class="shop-tabs">
                <button class="tab-btn active" onclick="switchShopTab('items')">ğŸ’ é“å…· & å¯µç‰©</button>
                <button class="tab-btn" onclick="switchShopTab('themes')">ğŸ¨ ç¶²é ä¸»é¡Œ</button>
                <button class="tab-btn" onclick="switchShopTab('gacha')">ğŸ å¹¸é‹æ‰­è›‹</button>
                <button class="tab-btn" onclick="switchShopTab('collection')">ğŸ† è²¼ç´™ç°¿</button>
            </div>

            <div id="shop-items-container" class="shop-grid">
                </div>
            
            <div id="sticker-book" style="display:none;">
                </div>
        </div>
    </div>

    <div id="rules-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="toggleRules()">&times;</span>
            <h3>ğŸ“œ è¦å‰‡èªªæ˜</h3>
            <ul>
                <li>ç­”å° +1 å¹£</li>
                <li>é€£å° 3 é¡Œ +1 å¹£ (å…±2)</li>
                <li>é€£å° 5 é¡Œ +3 å¹£ (å…±4)</li>
                <li>é€£å° 10 é¡Œ +5 å¹£ (å…±6)</li>
                <li>é€£å° 20 é¡Œ +10 å¹£ (å…±11)</li>
                <li><b>é›†é½Šè²¼ç´™ç°¿å¯ä»¥ç²å¾—ã€Œæ‹¼å­—å¤§å¸«ã€ç¨±è™Ÿï¼</b></li>
            </ul>
        </div>
    </div>

    <div id="gacha-animation" onclick="finishGacha()">
        <div style="margin-bottom: 20px;">é»æ“Šå¯¶ç®±æ‰“é–‹ï¼</div>
        <div class="gacha-box" id="gacha-box">ğŸ“¦</div>
        <div class="gacha-result" id="gacha-result"></div>
        <div id="gacha-msg" style="margin-top:20px; font-size: 1.5em; font-weight: bold;"></div>
        <div style="color: #aaa; font-size: 0.8em; margin-top: 20px;">(é»æ“Šè¢å¹•ç¹¼çºŒ)</div>
    </div>

    <script>
        // ç”¨ try-catch åŒ…è£¹ä»¥åµæ¸¬éŒ¯èª¤
        try {
            // --- 1. è³‡æ–™åº« (å–®å­—èˆ‡å•†å“) ---
            const wordList = {
                'Week 1': [['bank','éŠ€è¡Œ'],['camp','éœ²ç‡Ÿ'],['hand','æ‰‹'],['paint','æ²¹æ¼†'],['plant','æ¤ç‰©'],['pond','æ± å¡˜'],['pump','å¹«æµ¦'],['stamp','éƒµç¥¨'],['stand','ç«™ç«‹'],['stump','æ¨¹æ¨'],['wind','é¢¨'],['wink','çœ¨çœ¼'],['hungry','é£¢é¤“çš„'],['lapping','èˆ”ã€æ‹æ‰“(æ°´)'],['milk','ç‰›å¥¶'],['quiet','å®‰éœçš„'],['television','é›»è¦–'],['backyard','å¾Œé™¢'],['basement','åœ°ä¸‹å®¤'],['clean','æ‰“æƒ'],['fly up','é£›èµ·ä¾†'],['keep-away','èº²é¿éŠæˆ²'],['near','è¿‘çš„'],['upstairs','æ¨“ä¸Š']],
                'Week 2': [['belt','çš®å¸¶'],['elf','å°ç²¾éˆ'],['gift','ç¦®ç‰©'],['golf','é«˜çˆ¾å¤«'],['left','å·¦é‚Š'],['lift','æèµ·'],['melt','èåŒ–'],['quilt','æ£‰è¢«'],['raft','æœ¨ç­'],['shelf','æ¶å­'],['wilt','æ¯è'],['wolf','ç‹¼'],['came','ä¾†äº†'],['bait','é¤Œ'],['rake','è€™å­'],['hay','ä¹¾è‰'],['plate','ç›¤å­'],['pail','æ°´æ¡¶'],['cane','æ‹æ–'],['raise','èˆ‰èµ·'],['grape','è‘¡è„'],['say','èªª'],['aid','å¹«åŠ©'],['pain','ç–¼ç—›'],['trail','å°å¾‘'],['stain','æ±™æ¼¬'],['blaze','ç«ç„°'],['almost','å¹¾ä¹'],['dishes','ç›¤å­'],['everyone','æ¯å€‹äºº'],['family','å®¶äºº'],['later','ä¹‹å¾Œ'],['soup','æ¹¯'],['still','ä»ç„¶'],['together','ä¸€èµ·'],['window','çª—æˆ¶'],['children','å­©å­å€‘'],['collar','é ˜å­'],['heel','è…³è·Ÿ'],['hurt','å—å‚·'],['in front of','åœ¨â€¦å‰é¢'],['lean','å‚¾æ–œ'],['pet store','å¯µç‰©åº—'],['snort','å™´é¼»æ¯']],
                'Week 3': [['scrape','åˆ®'],['scratch','æŠ“'],['screen','è¢å¹•'],['scrub','ç”¨åŠ›æ“¦'],['splash','æ¿ºèµ·'],['split','åˆ†é–‹'],['sprain','æ‰­å‚·'],['spray','å™´ç‘'],['spring','æ˜¥å¤©/å½ˆç°§'],['strap','çš®å¸¶'],['stripes','æ¢ç´‹'],['strong','å¼·å£¯çš„'],['deep','æ·±çš„'],['meal','ä¸€é¤'],['sheep','ç¾Š'],['each','æ¯ä¸€å€‹'],['wheel','è¼ªå­'],['treat','æ‹›å¾…'],['bean','è±†å­'],['seen','çœ‹è¦‹'],['team','åœ˜éšŠ'],['dream','å¤¢'],['mean','æ„æ€æ˜¯'],['leave','é›¢é–‹'],['cream','å¥¶æ²¹'],['sleep','ç¡è¦º'],['sneeze','æ‰“å™´åš'],['copies','å‰¯æœ¬'],['enough','è¶³å¤ '],['library','åœ–æ›¸é¤¨'],['number','æ•¸å­—'],['prizes','çå“'],['ribbon','ç·å¸¶'],['ring','æˆ’æŒ‡'],['rope','ç¹©å­'],['sign','æ¨™èªŒ'],['tonight','ä»Šæ™š'],['happen','ç™¼ç”Ÿ'],['miss','æƒ³å¿µ'],['nice','å¥½çš„'],['steps','éšæ¢¯'],['terrible','å¯æ€•çš„']],
                'Week 4': [['knee','è†è“‹'],['kneel','è·ªä¸‹'],['knife','åˆ€'],['knit','ç·¨ç¹”'],['knob','åœ“å½¢æŠŠæ‰‹'],['knock','æ•²'],['knot','çµ'],['wrap','åŒ…èµ·ä¾†'],['wreath','èŠ±åœˆ'],['wrench','æ‰³æ‰‹'],['wrist','æ‰‹è…•'],['write','å¯«'],['wrong','éŒ¯çš„'],['shy','å®³ç¾çš„'],['right','æ­£ç¢ºçš„/å³é‚Š'],['wide','å¯¬çš„'],['light','å…‰/è¼•çš„'],['pine','æ¾æ¨¹'],['fight','æ‰“æ¶'],['fly','é£›'],['night','å¤œæ™š'],['dry','ä¹¾çš„'],['sight','è¦–ç·š'],['might','å¯èƒ½'],['tight','ç·Šçš„'],['stripe','æ¢ç´‹'],['sly','ç‹¡çŒ¾çš„'],['cry','å“­'],['basket','ç±ƒå­'],['bend down','å½ä¸‹'],['kind','è¦ªåˆ‡çš„/ç¨®é¡'],['wave','æ®æ‰‹/æ³¢æµª'],['enter','é€²å…¥'],['never','å¾ä¸'],['picture','åœ–ç‰‡'],['proud','é©•å‚²çš„'],['shiny','é–ƒäº®çš„'],['spray','å™´ç‘']],
                'Week 5': [['brick','ç£š'],['check','æª¢æŸ¥'],['chick','å°é›'],['clock','æ™‚é˜'],['duck','é´¨å­'],['lock','é–'],['pocket','å£è¢‹'],['rack','æ¶å­'],['rock','å²©çŸ³'],['rocket','ç«ç®­'],['snack','é»å¿ƒ'],['thick','åš'],['track','è»Œé“'],['poke','æˆ³'],['boat','èˆ¹'],['row','åˆ’èˆ¹'],['goat','å±±ç¾Š'],['snow','é›ª'],['toad','èŸ¾èœ'],['soap','è‚¥çš‚'],['blow','å¹'],['coat','å¤–å¥—'],['tow','æ‹–æ‹‰'],['coach','æ•™ç·´'],['float','æ¼‚æµ®'],['toast','åå¸'],['slow','æ…¢çš„'],['globe','åœ°çƒ'],['at once','ç«‹åˆ»'],['dog toys','ç‹—ç©å…·'],['guess','çŒœ'],['inside','è£¡é¢'],['judge','è©•åˆ¤'],['place','åœ°æ–¹']],
                'Week 6': [['bright','æ˜äº®çš„'],['caught','æŠ“åˆ°'],['eight','å…«'],['flight','é£›è¡Œ'],['high','é«˜çš„'],['knight','é¨å£«'],['light','å…‰'],['night','å¤œæ™š'],['right','æ­£ç¢ºçš„'],['sign','æ¨™èªŒ'],['sight','è¦–åŠ›'],['straight','ç›´çš„'],['tight','ç·Šçš„'],['tune','æ›²å­'],['moon','æœˆäº®'],['pool','æ¸¸æ³³æ± '],['zoo','å‹•ç‰©åœ’'],['rude','ç²—é­¯çš„'],['soon','å¾ˆå¿«'],['boot','é•·é´'],['food','é£Ÿç‰©'],['tube','ç®¡å­'],['room','æˆ¿é–“'],['moose','éº‹é¹¿'],['goose','éµ'],['zoom','å—–åœ°é£›'],['balloon','æ°£çƒ'],['shoot','å°„æ“Š'],['a can of','ä¸€ç½'],['enter','é€²å…¥'],['first','ç¬¬ä¸€'],['glitter','é–ƒå…‰'],['gold','é‡‘å­'],['prizes','çå“'],['second','ç¬¬äºŒ'],['sign up','å ±å'],['surely','ç•¶ç„¶'],['third','ç¬¬ä¸‰'],['look at','çœ‹è‘—'],['no cost','å…è²»'],['nod','é»é ­'],['paste','é»è²¼'],['permission','è¨±å¯']],
                'Week 7': [['basement','åœ°ä¸‹å®¤'],['bright-eyed','çœ¼ç¥æ˜äº®çš„'],['lean','å‚¾æ–œ'],['past','éå»'],['wrong','éŒ¯çš„'],['remember','è¨˜å¾—'],['clap','æ‹æ‰‹'],['crowd','äººç¾¤'],['hug','æ“æŠ±'],['nervous','ç·Šå¼µçš„'],['people','äººå€‘'],['ring','æˆ’æŒ‡ / éˆ´è²']],
                'Week 8': [['different','ä¸åŒçš„'],['hold up','èˆ‰èµ·'],['lay down','èººä¸‹'],['other','å…¶ä»–çš„'],['racehorse','è³½é¦¬'],['win','è´'],['winner','å‹åˆ©è€…']],
                'Week 9': [['what','ä»€éº¼'],['clash','è¡çª'],['shock','éœ‡é©š'],['while','ç•¶â€¦æ™‚'],['shame','å¯æƒœ'],['flash','é–ƒå…‰'],['where','å“ªè£¡'],['shine','ç™¼äº®'],['why','ç‚ºä»€éº¼'],['shore','æµ·å²¸'],['shall','å°‡è¦'],['share','åˆ†äº«'],['shadow','å½±å­'],['whisper','ä½èª'],['whiskers','é¬é¬š'],['different','ä¸åŒçš„'],['hold up','èˆ‰èµ·'],['lay down','èººä¸‹'],['other','å…¶ä»–çš„'],['racehorse','è³½é¦¬'],['win','è´'],['winner','å„ªå‹è€…'],['braid','è¾®å­'],['chain','éŠæ¢'],['hay','ä¹¾è‰'],['mail','éƒµä»¶'],['pail','æ°´æ¡¶'],['paint','æ²¹æ¼†'],['pay','ä»˜éŒ¢'],['rain','é›¨'],['sail','å¸† / èˆªè¡Œ'],['stain','æ±™æ¼¬'],['train','ç«è»Š'],['tray','æ‰˜ç›¤'],['beads','ç å­'],['bean','è±†å­'],['beef','ç‰›è‚‰'],['bread','éºµåŒ…'],['head','é ­'],['heel','è…³è·Ÿ'],['leaf','è‘‰å­'],['screen','è¢å¹•'],['seat','åº§ä½'],['steam','è’¸æ°£'],['thread','ç·š'],['tree','æ¨¹'],['climb','çˆ¬'],['myself','æˆ‘è‡ªå·±'],['practice','ç·´ç¿’'],['track','è»Œé“'],['uncle','å”å”'],['whiskers','é¬é¬š']],
                'Week 10': [['braid','è¾®å­'],['chain','éŠæ¢'],['hay','ä¹¾è‰'],['nail','æŒ‡ç”² / é‡˜å­'],['pail','æ°´æ¡¶'],['paint','æ²¹æ¼†'],['pay','ä»˜éŒ¢'],['rain','é›¨'],['sail','èˆªè¡Œ'],['stain','æ±™é»'],['beads','ç å­'],['bean','è±†å­'],['beef','ç‰›è‚‰'],['bead','ç å­'],['head','é ­'],['heel','è…³è·Ÿ'],['leaf','è‘‰å­'],['screen','è¢å¹•'],['seat','åº§ä½'],['steam','è’¸æ°£'],['thread','ç·š'],['tree','æ¨¹'],['climb','çˆ¬'],['myself','æˆ‘è‡ªå·±'],['practice','ç·´ç¿’'],['track','è»Œé“'],['uncle','å”å”'],['whiskers','é¬é¬š'],['wrote','å¯«äº†'],['clover','é…¢æ¼¿è‰'],['danger','å±éšª'],['field','ç”°é‡'],['noise','å™ªéŸ³'],['pass','ç¶“é'],['rest','ä¼‘æ¯'],['rumble','éš†éš†è²'],['sky','å¤©ç©º'],['thunder','é›·']],
                'Week 11': [['blow','å¹'],['bowl','ç¢—'],['crow','çƒé´‰'],['goat','å±±ç¾Š'],['pillow','æ•é ­'],['road','é“è·¯'],['snow','é›ª'],['soap','è‚¥çš‚'],['throw','ä¸Ÿ'],['toad','èŸ¾èœ'],['toast','åå¸'],['window','çª—æˆ¶'],['bath','æ´—æ¾¡'],['peach','æ¡ƒå­'],['tooth','ç‰™é½’'],['thin','ç˜¦çš„'],['choke','å™åˆ°'],['much','å¾ˆå¤š'],['with','å’Œ'],['chick','å°é›'],['teach','æ•™'],['thank','æ„Ÿè¬'],['child','å°å­©'],['chore','å®¶äº‹'],['reach','åˆ°é”'],['thick','åš'],['think','æ€è€ƒ'],['carrot','èƒ¡è˜¿è””'],['cool','æ¶¼çš„'],['gloves','æ‰‹å¥—'],['haircut','ç†é«®'],['patch','è£œä¸'],['pond','æ± å¡˜'],['spring','æ˜¥å¤©'],['voice','è²éŸ³'],['wool','ç¾Šæ¯›'],['acorn','æ©¡å­'],['angry','ç”Ÿæ°£çš„'],['as fast as','ç›¡å¯èƒ½å¿«'],['bless','ç¥ç¦'],['chattering','å–‹å–‹ä¸ä¼‘'],['dig','æŒ–'],['hill','å°å±±'],['oak','æ©¡æ¨¹'],['squirrel','æ¾é¼ '],['thief','å°å·'],['tiny','å¾ˆå°çš„']],
                'Week 12': [['boot','é•·é´'],['cook','ç…®'],['hood','å¸½å…œ'],['hook','é‰¤å­'],['hoop','åœˆ'],['moose','éº‹é¹¿'],['pool','æ¸¸æ³³æ± '],['school','å­¸æ ¡'],['shook','æ–å‹•'],['spoon','æ¹¯åŒ™'],['stood','ç«™ç«‹'],['stool','å‡³å­'],['cause','åŸå› '],['claw','çˆª'],['crawl','çˆ¬è¡Œ'],['draw','ç•«'],['faucet','æ°´é¾é ­'],['fawn','å°é¹¿'],['laundry','æ´—è¡£'],['paw','çˆªå­'],['sauce','é†¬æ±'],['shawl','æŠ«å·¾'],['straw','å¸ç®¡ / ç¨»è‰'],['yawn','æ‰“å“ˆæ¬ '],['behind','åœ¨å¾Œé¢'],['berry','æ¼¿æœ'],['branches','æ¨¹æ'],['bushy tail','æ¯›èŒ¸èŒ¸çš„å°¾å·´'],['dance','è·³èˆ'],['flag','æ——å­'],['insect','æ˜†èŸ²'],['quick','å¿«çš„'],['skunk','è‡­é¼¬'],['suddenly','çªç„¶åœ°']],
                'Week 13': [['blew','å¹äº†'],['chew','å’€åš¼'],['dew','éœ²æ°´'],['few','å°‘æ•¸'],['flew','é£›äº†'],['grew','æˆé•·'],['jewelry','ç å¯¶'],['mew','è²“å«'],['new','æ–°çš„'],['screw','èºçµ²'],['stew','ç‡‰èœ'],['threw','ä¸Ÿäº†'],['art','è—è¡“'],['yard','é™¢å­'],['barn','ç©€å€‰'],['park','å…¬åœ’'],['hard','å›°é›£çš„'],['cart','æ‰‹æ¨è»Š'],['dark','é»‘æš—'],['farm','è¾²å ´'],['shark','é¯Šé­š'],['sharp','éŠ³åˆ©çš„'],['harm','å‚·å®³'],['alarm','é¬§é˜'],['arms','æ‰‹è‡‚'],['march','ä¸‰æœˆ / è¡Œé€²'],['smart','è°æ˜çš„'],['buzzing','å—¡å—¡è²'],['careful','å°å¿ƒçš„'],['fur','æ¯›'],['hit','æ‰“'],['hole','æ´'],['honey','èœ‚èœœ'],['lick','èˆ”'],['path','å°è·¯'],['sting','è«'],['stuck','å¡ä½çš„'],['against','åå°'],['hardly','å¹¾ä¹ä¸'],['meadow','è‰åœ°'],['middle','ä¸­é–“'],['pit-pat','å™ å™ è²'],['space','ç©ºé–“'],['toss','ä¸Ÿ'],['touch','è§¸ç¢°'],['whistle','å£å“¨']],
                'Week 15': [['baby','å¬°å…’'],['bunny','å°å…”å­'],['city','åŸå¸‚'],['cry','å“­'],['dry','ä¹¾çš„'],['fly','é£›'],['fry','ç‚¸'],['happy','å¿«æ¨‚çš„'],['party','æ´¾å°'],['pony','å°é¦¬'],['silly','å‚»çš„'],['sky','å¤©ç©º'],['story','æ•…äº‹'],['chain','éˆå­'],['chop','åˆ‡'],['shed','æ£šå­'],['shelf','æ¶å­'],['thick','åš'],['thin','ç˜¦çš„'],['think','æ€è€ƒ'],['thread','ç·š'],['three','ä¸‰'],['throat','å–‰åš¨'],['whale','é¯¨é­š'],['wheel','è¼ªå­'],['shines','ç™¼å…‰'],['through','ç©¿é'],['bouncing','å½ˆè·³çš„'],['spider','èœ˜è››'],['webs','ç¶²'],['woods','æ¨¹æ—'],['glass','ç»ç’ƒ'],['tied together','ç¶åœ¨ä¸€èµ·'],['drop','æ‰ä¸‹'],['straight','ç›´çš„'],['friendly','å‹å–„çš„'],['bless','ç¥ç¦'],['blink','çœ¨çœ¼'],['crawl','çˆ¬'],['flat','å¹³çš„'],['follow','è·Ÿéš¨'],['join','åŠ å…¥'],['rock','å²©çŸ³'],['star','æ˜Ÿæ˜Ÿ'],['swish','å”°åœ°ä¸€è²']],
                'Week 16': [['bath','æ´—æ¾¡'],['bench','é•·å‡³'],['branch','æ¨¹æ'],['brush','åˆ·å­'],['dish','ç›¤å­'],['ditch','æºæ¸ '],['path','å°å¾‘'],['ring','æˆ’æŒ‡'],['swing','ç›ªé¦éŸ†'],['switch','é–‹é—œ'],['teeth','ç‰™é½’'],['watch','æ‰‹éŒ¶'],['bird','é³¥'],['more','æ›´å¤š'],['shirt','è¥¯è¡«'],['horse','é¦¬'],['first','ç¬¬ä¸€'],['for','ç‚ºäº†'],['girl','å¥³å­©'],['horn','è§’'],['dirt','æ³¥åœŸ'],['short','çŸ­çš„'],['store','å•†åº—'],['morning','æ—©æ™¨'],['dinosaur','æé¾'],['third','ç¬¬ä¸‰'],['whirl','æ—‹è½‰'],['appear','å‡ºç¾'],['decide','æ±ºå®š'],['furry','æ¯›èŒ¸èŒ¸çš„'],['sister','å§å¦¹'],['strange','å¥‡æ€ªçš„'],['tease','å–ç¬‘']],
                'Week 17': [['barn','ç©€å€‰'],['card','å¡ç‰‡'],['dart','é£›é¢'],['fern','è•¨é¡'],['harp','è±ç´'],['ladder','æ¢¯å­'],['letter','ä¿¡'],['number','æ•¸å­—'],['paper','ç´™'],['shark','é¯Šé­š'],['slipper','æ‹–é‹'],['water','æ°´'],['yard','é™¢å­'],['flutter','æ‹å‹•'],['flyer','å‚³å–®'],['minute','åˆ†é˜'],['nearby','é™„è¿‘'],['reach','åˆ°é”'],['seem','ä¼¼ä¹'],['throat','å–‰åš¨'],['hummingbird','èœ‚é³¥'],['afraid','å®³æ€•'],['exclaimed','é©šå‘¼'],['frightened','å®³æ€•çš„'],['lift','æŠ¬èµ·'],['shut','é—œä¸Š'],['stretch','ä¼¸å±•'],['wide','å¯¬çš„']],
                'Week 18': [['cork','è»Ÿæœ¨å¡'],['corn','ç‰ç±³'],['dirt','æ³¥åœŸ'],['fork','å‰å­'],['horn','è§’'],['shirt','è¥¯è¡«'],['short','çŸ­çš„'],['skirt','è£™å­'],['squirt','å™´å‡º'],['stir','æ”ªæ‹Œ'],['storm','æš´é¢¨é›¨'],['third','ç¬¬ä¸‰'],['thorn','èŠæ£˜'],['burn','ç‡’'],['curb','è·¯é‚Š'],['curl','æ²æ›²'],['fur','æ¯›'],['hurt','å—å‚·'],['turn','è½‰å½'],['does','åš(3rd)'],['were','æ˜¯(éå»)'],['every','æ¯å€‹'],['very','éå¸¸'],['give','çµ¦'],['live','ç”Ÿæ´»'],['thing','æ±è¥¿'],['your','ä½ çš„'],['many','è¨±å¤š'],['who','èª°'],['any','ä»»ä½•'],['away','é›¢é–‹'],['goes','å»(3rd)'],['find','æ‰¾åˆ°'],['kind','ç¨®é¡/å¥½çš„'],['ago','ä»¥å‰'],['another','å¦ä¸€å€‹'],['corner','è§’è½'],['everywhere','åˆ°è™•'],['fold','æ‘º'],['important','é‡è¦çš„'],['mouse','è€é¼ '],['neck','è„–å­'],['owl','è²“é ­é·¹'],['sharp','éŠ³åˆ©çš„'],['size','å°ºå¯¸'],['supper','æ™šé¤'],['argue','çˆ­åµ'],['bright','æ˜äº®çš„'],['button','éˆ•æ‰£'],['chuckle','è¼•ç¬‘'],['ladybug','ç“¢èŸ²'],['prettiest','æœ€æ¼‚äº®çš„'],['shout','å«å–Š'],['spots','æ–‘é»'],['whole','æ•´å€‹çš„']]
            };

            // æ“´å……ç‰ˆè²¼ç´™åº« (60 items)
            const stickers = [
                // æ™®é€š (Common) - 40%
                {id: 's01', icon: 'ğŸ¶', name: 'å°ç‹—', rarity: 'æ™®é€š'}, {id: 's02', icon: 'ğŸ±', name: 'å°è²“', rarity: 'æ™®é€š'},
                {id: 's03', icon: 'ğŸ­', name: 'è€é¼ ', rarity: 'æ™®é€š'}, {id: 's04', icon: 'ğŸ¹', name: 'å€‰é¼ ', rarity: 'æ™®é€š'},
                {id: 's05', icon: 'ğŸ°', name: 'å…”å­', rarity: 'æ™®é€š'}, {id: 's06', icon: 'ğŸ', name: 'è˜‹æœ', rarity: 'æ™®é€š'},
                {id: 's07', icon: 'ğŸŒ', name: 'é¦™è•‰', rarity: 'æ™®é€š'}, {id: 's08', icon: 'ğŸ‰', name: 'è¥¿ç“œ', rarity: 'æ™®é€š'},
                {id: 's09', icon: 'ğŸ¦', name: 'å†°æ·‡æ·‹', rarity: 'æ™®é€š'}, {id: 's10', icon: 'ğŸ©', name: 'ç”œç”œåœˆ', rarity: 'æ™®é€š'},
                {id: 's11', icon: 'ğŸš—', name: 'æ±½è»Š', rarity: 'æ™®é€š'}, {id: 's12', icon: 'ğŸš•', name: 'è¨ˆç¨‹è»Š', rarity: 'æ™®é€š'},
                {id: 's13', icon: 'ğŸš²', name: 'è…³è¸è»Š', rarity: 'æ™®é€š'}, {id: 's14', icon: 'âš½', name: 'è¶³çƒ', rarity: 'æ™®é€š'},
                {id: 's15', icon: 'ğŸ€', name: 'ç±ƒçƒ', rarity: 'æ™®é€š'}, {id: 's16', icon: 'ğŸ§¢', name: 'å¸½å­', rarity: 'æ™®é€š'},
                {id: 's17', icon: 'ğŸ¸', name: 'å‰ä»–', rarity: 'æ™®é€š'}, {id: 's18', icon: 'ğŸ¥', name: 'é¼“', rarity: 'æ™®é€š'},
                {id: 's19', icon: 'ğŸ ', name: 'æˆ¿å­', rarity: 'æ™®é€š'}, {id: 's20', icon: 'â°', name: 'é¬§é˜', rarity: 'æ™®é€š'},
                
                // ç¨€æœ‰ (Rare) - 30%
                {id: 's21', icon: 'ğŸ¦', name: 'ç…å­', rarity: 'ç¨€æœ‰'}, {id: 's22', icon: 'ğŸ¯', name: 'è€è™', rarity: 'ç¨€æœ‰'},
                {id: 's23', icon: 'ğŸ¦–', name: 'æš´é¾', rarity: 'ç¨€æœ‰'}, {id: 's24', icon: 'ğŸ¦•', name: 'é›·é¾', rarity: 'ç¨€æœ‰'},
                {id: 's25', icon: 'ğŸ¦ˆ', name: 'é¯Šé­š', rarity: 'ç¨€æœ‰'}, {id: 's26', icon: 'ğŸ¦…', name: 'è€é·¹', rarity: 'ç¨€æœ‰'},
                {id: 's27', icon: 'ğŸš“', name: 'è­¦è»Š', rarity: 'ç¨€æœ‰'}, {id: 's28', icon: 'ğŸš’', name: 'æ¶ˆé˜²è»Š', rarity: 'ç¨€æœ‰'},
                {id: 's29', icon: 'ğŸš‘', name: 'æ•‘è­·è»Š', rarity: 'ç¨€æœ‰'}, {id: 's30', icon: 'âœˆï¸', name: 'é£›æ©Ÿ', rarity: 'ç¨€æœ‰'},
                {id: 's31', icon: 'ğŸš€', name: 'ç«ç®­', rarity: 'ç¨€æœ‰'}, {id: 's32', icon: 'ğŸš‚', name: 'ç«è»Š', rarity: 'ç¨€æœ‰'},
                {id: 's33', icon: 'ğŸ”', name: 'æ¼¢å ¡', rarity: 'ç¨€æœ‰'}, {id: 's34', icon: 'ğŸ•', name: 'æŠ«è–©', rarity: 'ç¨€æœ‰'},
                {id: 's35', icon: 'ğŸŸ', name: 'è–¯æ¢', rarity: 'ç¨€æœ‰'}, {id: 's36', icon: 'ğŸ®', name: 'æ–æ¡¿', rarity: 'ç¨€æœ‰'},
                {id: 's37', icon: 'ğŸ‘¾', name: 'å¤–æ˜Ÿæ€ª', rarity: 'ç¨€æœ‰'}, {id: 's38', icon: 'ğŸ¤–', name: 'æ©Ÿå™¨äºº', rarity: 'ç¨€æœ‰'},
                {id: 's39', icon: 'ğŸ’€', name: 'éª·é«', rarity: 'ç¨€æœ‰'}, {id: 's40', icon: 'ğŸƒ', name: 'å—ç“œ', rarity: 'ç¨€æœ‰'},

                // å‚³èªª (Legend) - 20%
                {id: 's41', icon: 'ğŸ²', name: 'ç¥é¾', rarity: 'å‚³èªª'}, {id: 's42', icon: 'ğŸ¦„', name: 'ç¨è§’ç¸', rarity: 'å‚³èªª'},
                {id: 's43', icon: 'ğŸ‘½', name: 'å¤–æ˜Ÿäºº', rarity: 'å‚³èªª'}, {id: 's44', icon: 'ğŸ‘»', name: 'å¹½éˆ', rarity: 'å‚³èªª'},
                {id: 's45', icon: 'ğŸ§›', name: 'å¸è¡€é¬¼', rarity: 'å‚³èªª'}, {id: 's46', icon: 'ğŸ§œâ€â™€ï¸', name: 'ç¾äººé­š', rarity: 'å‚³èªª'},
                {id: 's47', icon: 'ğŸ§â€â™‚ï¸', name: 'ç²¾éˆ', rarity: 'å‚³èªª'}, {id: 's48', icon: 'ğŸ¦¸', name: 'è¶…ç´šè‹±é›„', rarity: 'å‚³èªª'},
                {id: 's49', icon: 'ğŸ¥·', name: 'å¿è€…', rarity: 'å‚³èªª'}, {id: 's50', icon: 'ğŸ›¸', name: 'UFO', rarity: 'å‚³èªª'},
                {id: 's51', icon: 'ğŸš', name: 'ç›´å‡æ©Ÿ', rarity: 'å‚³èªª'}, {id: 's52', icon: 'ğŸï¸', name: 'è³½è»Š', rarity: 'å‚³èªª'},

                // å²è©© (Epic) - 9%
                {id: 's53', icon: 'ğŸ‘‘', name: 'çš‡å† ', rarity: 'å²è©©'}, {id: 's54', icon: 'ğŸ’', name: 'é‘½çŸ³', rarity: 'å²è©©'},
                {id: 's55', icon: 'ğŸ†', name: 'çç›ƒ', rarity: 'å²è©©'}, {id: 's56', icon: 'ğŸŒŸ', name: 'æ˜Ÿæ˜Ÿ', rarity: 'å²è©©'},
                {id: 's57', icon: 'ğŸŒˆ', name: 'å½©è™¹', rarity: 'å²è©©'}, {id: 's58', icon: 'ğŸŒ‹', name: 'ç«å±±', rarity: 'å²è©©'},

                // ç¥è©± (Mythic) - 1%
                {id: 's59', icon: 'ğŸ”±', name: 'æµ·ç¥ä¸‰å‰æˆŸ', rarity: 'ç¥è©±'}, {id: 's60', icon: 'ğŸ‰', name: 'é å¤å·¨é¾', rarity: 'ç¥è©±'}
            ];

            // å•†åº—ç‰©å“å®šç¾©
            const shopData = {
                items: [
                    {id: 'pet_dog', type: 'pet', name: 'å¿ èª å°ç‹—', icon: 'ğŸ•', cost: 20, desc: 'æœ€æ£’çš„å­¸ç¿’å¤¥ä¼´'},
                    {id: 'pet_cat', type: 'pet', name: 'è°æ˜è²“å’ª', icon: 'ğŸˆ', cost: 25, desc: 'é™ªä½ ä¸€èµ·å®‰éœçœ‹æ›¸'},
                    {id: 'pet_robot', type: 'pet', name: 'AI æ©Ÿå™¨äºº', icon: 'ğŸ¤–', cost: 50, desc: 'ä¾†è‡ªæœªä¾†çš„ç§‘æŠ€'},
                    {id: 'pet_dino', type: 'pet', name: 'å°æš´é¾', icon: 'ğŸ¦–', cost: 80, desc: 'è¶…é…·çš„å²å‰å¯µç‰©'},
                    {id: 'hint_pass', type: 'consumable', name: 'æç¤ºå¡', icon: 'ğŸ’¡', cost: 100, desc: 'æ°¸ä¹…è§£é–ã€Œæç¤ºã€æŒ‰éˆ•', oneTime: true}
                ],
                themes: [
                    {id: 'theme-forest', type: 'theme', name: 'æ£®æ—æ¢éšª', icon: 'ğŸŒ²', cost: 0, desc: 'é è¨­çš„ç¶ è‰²é¢¨æ ¼'},
                    {id: 'theme-ocean', type: 'theme', name: 'æ·±æµ·æ½›æ°´', icon: 'ğŸ³', cost: 30, desc: 'æ¸…æ¶¼çš„è—è‰²é¢¨æ ¼'},
                    {id: 'theme-dark', type: 'theme', name: 'æš—å¤œæ¨¡å¼', icon: 'ğŸŒ™', cost: 40, desc: 'ä¿è­·çœ¼ç›çš„é»‘è‰²é¢¨æ ¼'},
                    {id: 'theme-lego', type: 'theme', name: 'ç©æœ¨æ¨‚åœ’', icon: 'ğŸ§±', cost: 50, desc: 'é®®è±”æ´»æ½‘çš„é…è‰²'},
                    {id: 'theme-space', type: 'theme', name: 'å¤ªç©ºæ¼«éŠ', icon: 'ğŸŒŒ', cost: 60, desc: 'æ·±è—è‰²å®‡å®™é¢¨æ ¼'}
                ]
            };

            // --- 2. ç‹€æ…‹ç®¡ç† (State) ---
            let gameState = {
                coins: 0,
                streak: 0,
                inventory: [], 
                stickers: [], 
                activePet: null,
                activeTheme: 'theme-forest',
                userNotes: {}
            };

            // é‹è¡Œæ™‚è®Šæ•¸
            let currentWeekWords = [];
            let currentIndex = 0;
            let currentWord = null;
            let isQuizActive = false;
            let hintUsed = false;

            // --- 3. åˆå§‹åŒ–èˆ‡å„²å­˜ ---
            window.onload = function() {
                try {
                    loadGame();
                    initWeekSelect();
                    applyTheme(gameState.activeTheme);
                    updateUI();
                    window.speechSynthesis.getVoices();
                } catch (e) {
                    alert("åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®šï¼š" + e.message);
                }
            };

            function saveGame() {
                localStorage.setItem('pierceSpellAdventure_v3', JSON.stringify(gameState));
                updateUI();
            }

            function loadGame() {
                let saved = localStorage.getItem('pierceSpellAdventure_v3');
                if (!saved) saved = localStorage.getItem('pierceSpellAdventure');

                if(saved) {
                    const parsed = JSON.parse(saved);
                    gameState = { ...gameState, ...parsed }; 
                    // ä¿®å¾©èˆŠç‰ˆ ID
                    if(gameState.activeTheme.includes('_')) {
                        gameState.activeTheme = gameState.activeTheme.replace('_', '-');
                    }
                    gameState.inventory = gameState.inventory.map(item => item.replace('_', '-'));
                }
                
                if(!gameState.inventory.includes('theme-forest')) gameState.inventory.push('theme-forest');
            }

            function initWeekSelect() {
                const select = document.getElementById('week-select');
                if (!wordList || Object.keys(wordList).length === 0) {
                    alert("è­¦å‘Šï¼šå–®å­—åº«è¼‰å…¥å¤±æ•—ï¼");
                    return;
                }
                // åˆä½µæ‰€æœ‰ Week (æ ¹æ“š key ä¸­çš„æ•¸å­—æ’åº)
                Object.keys(wordList).sort((a,b) => {
                    return parseInt(a.split(' ')[1]) - parseInt(b.split(' ')[1]);
                }).forEach(key => {
                    let opt = document.createElement('option');
                    opt.value = key;
                    opt.innerText = key;
                    select.appendChild(opt);
                });
            }

            // --- 4. éŠæˆ²æ ¸å¿ƒé‚è¼¯ ---
            function loadWeek() {
                const week = document.getElementById('week-select').value;
                if(!week) return;

                currentWeekWords = [...wordList[week]]; 
                currentWeekWords.sort(() => Math.random() - 0.5);
                
                currentIndex = 0;
                startQuestion();
            }

            function startQuestion() {
                if(currentIndex >= currentWeekWords.length) {
                    showMessage('ğŸ‰ æœ¬é€±å–®å­—å…¨éƒ¨å®Œæˆï¼å¤ªæ£’äº†ï¼', 'success');
                    document.getElementById('status-text').innerText = 'æŒ‘æˆ°å®Œæˆ';
                    document.getElementById('next-btn').disabled = true;
                    return;
                }

                isQuizActive = true;
                hintUsed = false;
                currentWord = currentWeekWords[currentIndex]; 
                
                document.getElementById('status-text').innerText = `ç¬¬ ${currentIndex + 1} é¡Œ`;
                document.getElementById('word-display').innerText = 'ğŸ§ è«‹è½ç™¼éŸ³...';
                document.getElementById('chinese-display').innerText = ''; 
                document.getElementById('answer-input').value = '';
                document.getElementById('answer-input').disabled = false;
                document.getElementById('answer-input').focus();
                document.getElementById('message-box').innerHTML = '';
                
                document.getElementById('submit-btn').disabled = false;
                document.getElementById('next-btn').disabled = true;
                document.getElementById('speak-btn').disabled = false;
                document.getElementById('record-btn').disabled = false;

                const hasHintPass = gameState.inventory.includes('hint_pass');
                document.getElementById('hint-btn').style.display = hasHintPass ? 'inline-block' : 'none';
                document.getElementById('hint-btn').disabled = false;

                const note = gameState.userNotes[currentWord[0]];
                document.getElementById('user-hint-display').innerText = note ? `ğŸ“ ç­†è¨˜: ${note}` : '';

                setTimeout(speakCurrentWord, 500);
            }

            function speakCurrentWord() {
                if(!currentWord) return;
                const utter = new SpeechSynthesisUtterance(currentWord[0]);
                utter.lang = 'en-US';
                utter.rate = 0.8; 
                window.speechSynthesis.speak(utter);
            }

            function checkAnswer() {
                if(!isQuizActive) return;

                const input = document.getElementById('answer-input').value.trim().toLowerCase();
                const target = currentWord[0].toLowerCase();

                if(input === target) {
                    processWin();
                } else {
                    showMessage('âŒ å“å‘€ï¼å†è©¦ä¸€æ¬¡ï¼', 'error');
                    gameState.streak = 0;
                    document.getElementById('answer-input').value = '';
                    document.getElementById('answer-input').focus();
                    saveGame();
                }
            }

            function processWin() {
                isQuizActive = false;
                
                let gained = 1;
                gameState.streak++;
                if(gameState.streak % 20 === 0) gained += 10;
                else if(gameState.streak % 10 === 0) gained += 5;
                else if(gameState.streak % 5 === 0) gained += 3;
                else if(gameState.streak % 3 === 0) gained += 1;

                gameState.coins += gained;
                
                document.getElementById('word-display').innerText = currentWord[0]; 
                document.getElementById('chinese-display').innerText = currentWord[1]; 
                showMessage(`âœ… ç­”å°äº†ï¼ +${gained} ğŸ’° (é€£å°: ${gameState.streak})`, 'success');
                
                document.getElementById('answer-input').disabled = true;
                document.getElementById('submit-btn').disabled = true;
                document.getElementById('next-btn').disabled = false;
                document.getElementById('hint-btn').disabled = true;

                saveGame();
            }

            function nextQuestion() {
                currentIndex++;
                startQuestion();
            }

            function showMessage(text, type) {
                const box = document.getElementById('message-box');
                box.className = `message msg-${type}`;
                box.innerText = text;
            }

            function useHint() {
                if(!currentWord || hintUsed) return;
                
                if(gameState.coins < 5) {
                    alert('é‡‘å¹£ä¸è¶³ 5 å¹£ï¼Œç„¡æ³•ä½¿ç”¨æç¤ºï¼');
                    return;
                }

                gameState.coins -= 5;
                hintUsed = true;
                const w = currentWord[0];
                const hint = w.charAt(0) + ' _ '.repeat(w.length - 1);
                document.getElementById('word-display').innerText = `æç¤º: ${hint}`;
                saveGame();
            }

            function recordHint() {
                if(!currentWord) return;
                const note = prompt(`ç‚ºå–®å­— "${currentWord[0]}" å¯«ä¸‹ç­†è¨˜ (ä¾‹å¦‚: åª½åª½èªªé€™åƒ...)`);
                if(note) {
                    gameState.userNotes[currentWord[0]] = note;
                    document.getElementById('user-hint-display').innerText = `ğŸ“ ç­†è¨˜: ${note}`;
                    saveGame();
                }
            }

            // --- 5. å•†åº—ç³»çµ±é‚è¼¯ ---
            function toggleShop() {
                const modal = document.getElementById('shop-modal');
                const isOpen = modal.style.display === 'block';
                modal.style.display = isOpen ? 'none' : 'block';
                if(!isOpen) {
                    document.getElementById('shop-coins').innerText = gameState.coins;
                    switchShopTab('items'); 
                }
            }

            function switchShopTab(tabName) {
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');

                const container = document.getElementById('shop-items-container');
                const stickerBook = document.getElementById('sticker-book');
                container.innerHTML = '';
                container.style.display = 'grid';
                stickerBook.style.display = 'none';

                if(tabName === 'items') renderShopItems(shopData.items);
                else if (tabName === 'themes') renderShopItems(shopData.themes);
                else if (tabName === 'gacha') renderGachaPage(container);
                else if (tabName === 'collection') {
                    container.style.display = 'none';
                    stickerBook.style.display = 'grid';
                    renderStickerBook();
                }
            }

            function renderShopItems(list) {
                const container = document.getElementById('shop-items-container');
                list.forEach(item => {
                    const owned = gameState.inventory.includes(item.id);
                    const isActive = (item.type === 'theme' && gameState.activeTheme === item.id) || (item.type === 'pet' && gameState.activePet === item.id);
                    
                    const div = document.createElement('div');
                    div.className = `shop-card ${owned ? 'owned' : ''}`;
                    
                    let btnHtml = '';
                    if (owned) {
                        if (item.type === 'theme' || item.type === 'pet') {
                            btnHtml = `<button class="btn-primary" onclick="equipItem('${item.id}', '${item.type}')" ${isActive ? 'disabled' : ''}>${isActive ? 'ä½¿ç”¨ä¸­' : 'è£å‚™'}</button>`;
                        } else {
                            btnHtml = `<button disabled>å·²æ“æœ‰</button>`;
                        }
                    } else {
                        btnHtml = `<button class="btn-shop" onclick="buyItem('${item.id}', ${item.cost})">è³¼è²· ${item.cost}ğŸ’°</button>`;
                    }

                    div.innerHTML = `
                        <span class="shop-icon">${item.icon}</span>
                        <b>${item.name}</b>
                        <span class="shop-desc">${item.desc}</span>
                        ${btnHtml}
                    `;
                    container.appendChild(div);
                });
            }

            function buyItem(itemId, cost) {
                if(gameState.coins < cost) {
                    alert('é‡‘å¹£ä¸è¶³ï¼å¿«å»ç·´ç¿’æ‹¼å­—è³ºéŒ¢å§ï¼');
                    return;
                }

                if(!confirm(`ç¢ºå®šè¦èŠ±è²» ${cost} é‡‘å¹£è³¼è²·å—ï¼Ÿ`)) return;

                gameState.coins -= cost;
                gameState.inventory.push(itemId);
                document.getElementById('shop-coins').innerText = gameState.coins;
                
                const activeTab = document.querySelector('.tab-btn.active');
                activeTab.click();
                
                saveGame();
                alert('è³¼è²·æˆåŠŸï¼');
            }

            function equipItem(itemId, type) {
                if(type === 'theme') {
                    gameState.activeTheme = itemId;
                    applyTheme(itemId);
                } else if(type === 'pet') {
                    if(gameState.activePet === itemId) gameState.activePet = null;
                    else gameState.activePet = itemId;
                }
                
                updateUI();
                saveGame();
                document.querySelector('.tab-btn.active').click();
            }

            function applyTheme(themeId) {
                document.body.className = themeId;
            }

            // --- 6. æ‰­è›‹èˆ‡è²¼ç´™ç°¿ ---
            function renderGachaPage(container) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 20px;">
                        <div style="font-size: 5em; margin-bottom: 20px;">ğŸ</div>
                        <h3>å¹¸é‹ç¥ç§˜å¯¶ç®±</h3>
                        <p>éš¨æ©Ÿç²å¾—ä¸€å¼µè²¼ç´™ï¼</p>
                        <p style="color: #666; font-size: 0.9em; margin-bottom: 20px;">
                            æ©Ÿç‡ï¼šæ™®é€š40% | ç¨€æœ‰30% | å‚³èªª20% | å²è©©9% | <span style="color:#00ffff; font-weight:bold;">ç¥è©±1%</span>
                        </p>
                        <button class="btn-shop" style="font-size: 1.5em; padding: 15px 30px;" onclick="startGacha()">
                            æŠ½ä¸€æ¬¡ (50 ğŸ’°)
                        </button>
                    </div>
                `;
            }

            window.startGacha = function() {
                if(gameState.coins < 50) {
                    alert('éœ€è¦ 50 é‡‘å¹£æ‰èƒ½æŠ½çå–”ï¼');
                    return;
                }
                gameState.coins -= 50;
                document.getElementById('shop-coins').innerText = gameState.coins;
                saveGame();

                const animLayer = document.getElementById('gacha-animation');
                const box = document.getElementById('gacha-box');
                const result = document.getElementById('gacha-result');
                const msg = document.getElementById('gacha-msg');
                
                animLayer.style.display = 'block';
                box.style.display = 'block';
                result.style.display = 'none';
                msg.innerText = '';
                
                const rand = Math.random() * 100;
                let rarity = 'æ™®é€š';
                if(rand > 99) rarity = 'ç¥è©±'; 
                else if(rand > 90) rarity = 'å²è©©'; 
                else if(rand > 70) rarity = 'å‚³èªª'; 
                else if(rand > 40) rarity = 'ç¨€æœ‰'; 
                
                const pool = stickers.filter(s => s.rarity === rarity);
                const finalPool = pool.length > 0 ? pool : stickers;
                const prize = finalPool[Math.floor(Math.random() * finalPool.length)];

                let isNew = false;
                let refund = 0;
                if(!gameState.stickers.includes(prize.id)) {
                    gameState.stickers.push(prize.id);
                    isNew = true;
                } else {
                    if(rarity === 'æ™®é€š') refund = 10;
                    else if(rarity === 'ç¨€æœ‰') refund = 15;
                    else if(rarity === 'å‚³èªª') refund = 20;
                    else if(rarity === 'å²è©©') refund = 30;
                    else refund = 50;
                    gameState.coins += refund;
                }
                saveGame();

                animLayer.onclick = function() {
                    box.style.display = 'none';
                    result.style.display = 'block';
                    result.innerText = prize.icon;
                    
                    let rarityClass = '';
                    if(rarity === 'ç¨€æœ‰') rarityClass = 'rarity-rare';
                    else if(rarity === 'å‚³èªª') rarityClass = 'rarity-legend';
                    else if(rarity === 'å²è©©') rarityClass = 'rarity-epic';
                    else if(rarity === 'ç¥è©±') rarityClass = 'rarity-mythic';
                    else rarityClass = 'rarity-common';

                    let html = `<div class="${rarityClass}">${prize.name}</div><div style="font-size:0.5em; margin-top:5px;">(${rarity})</div>`;
                    if(!isNew) html += `<div style="color: gold; font-size: 0.4em; margin-top: 10px;">å·²æ“æœ‰ï¼é€€é‚„ ${refund} ğŸ’°</div>`;
                    else html += `<div style="color: #fff; font-size: 0.4em; margin-top: 10px;">âœ¨ NEW! æ–°è²¼ç´™ âœ¨</div>`;
                    
                    msg.innerHTML = html;
                    
                    animLayer.onclick = function() {
                        animLayer.style.display = 'none';
                    };
                };
            }

            window.finishGacha = function() {
                // Placeholder
            }

            function renderStickerBook() {
                const book = document.getElementById('sticker-book');
                book.innerHTML = '';
                
                stickers.forEach(s => {
                    const owned = gameState.stickers.includes(s.id);
                    const div = document.createElement('div');
                    div.className = `sticker-slot ${owned ? 'unlocked' : ''} r-${s.rarity}`;
                    div.innerText = owned ? s.icon : '?';
                    div.title = s.name + (owned ? '' : ' (æœªè§£é–)');
                    book.appendChild(div);
                });

                const progressDiv = document.createElement('div');
                progressDiv.style.gridColumn = '1 / -1';
                progressDiv.style.textAlign = 'center';
                progressDiv.style.marginTop = '10px';
                progressDiv.innerHTML = `æ”¶é›†é€²åº¦: ${gameState.stickers.length} / ${stickers.length}`;
                book.prepend(progressDiv);
            }

            // --- 7. é€šç”¨ UI æ›´æ–° ---
            window.toggleRules = function() {
                const m = document.getElementById('rules-modal');
                m.style.display = (m.style.display === 'block') ? 'none' : 'block';
            }

            window.updateUI = function() {
                document.getElementById('coin-count').innerText = gameState.coins;
                document.getElementById('streak-count').innerText = gameState.streak;
                
                const petDiv = document.getElementById('pet-display');
                if(gameState.activePet) {
                    const petItem = shopData.items.find(i => i.id === gameState.activePet);
                    if(petItem) {
                        petDiv.style.display = 'inline-block';
                        petDiv.innerText = petItem.icon;
                    }
                } else {
                    petDiv.style.display = 'none';
                }
            }

            // æŠŠå‡½æ•¸æš´éœ²çµ¦å…¨å±€ï¼Œå› ç‚º HTML onclick éœ€è¦å‘¼å«
            window.loadWeek = loadWeek;
            window.checkAnswer = checkAnswer;
            window.nextQuestion = nextQuestion;
            window.speakCurrentWord = speakCurrentWord;
            window.useHint = useHint;
            window.recordHint = recordHint;
            window.toggleShop = toggleShop;
            window.switchShopTab = switchShopTab;
            window.buyItem = buyItem;
            window.equipItem = equipItem;

        } catch (error) {
            console.error(error);
            alert("ç¨‹å¼ç¢¼è¼‰å…¥ç™¼ç”ŸéŒ¯èª¤: " + error.message);
        }
    </script>
</body>
</html>
